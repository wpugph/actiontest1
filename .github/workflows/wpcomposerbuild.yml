name: Pantheon Build

on: [push]

jobs:
  build:

    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v1
    - name: Setup SSH access to Pantheon
      run: |
        # define variables
        export PANTHEONEMAIL="cralberto11@gmail.com"
        export PANTHEONSITENAME="carltest1"
        export PANTHEONSITEUUID="01507cf9-d5e7-460d-83ee-5587a03e7d9a"
        export PANTHEONENV="dev"
        export PATH="$PATH:$COMPOSER_HOME/vendor/bin"
        export PROJECT_ROOT="$(pwd)"
        export HTDOCS="$HOME/htdocs"
        export GITHUB_BRANCH=${GITHUB_REF##*heads/}
        export MACHINETOKEN="${{ secrets.MACHINETOKEN }}"
        # setup SSH access
        printf "[\e[0;34mNOTICE\e[0m] Setting up SSH access to server for rsync usage.\n"
        SSH_DIR="$HOME/.ssh"
        mkdir -p "$SSH_DIR"
        chmod 700 "$SSH_DIR"
        touch "$SSH_DIR/id_rsa1"
        echo "${{ secrets.STAGING_PRIVATE_KEY }}" > "$SSH_DIR/id_rsa1"
        chmod 600 "$SSH_DIR/id_rsa1"
        eval "$(ssh-agent -s)"
        ssh-add "$SSH_DIR/id_rsa1"
        ssh-add -l
        echo "SSH PRIVATE KEY IMPORTED!!!"

        sh $PROJECT_ROOT/scripts/github/setup-terminus
        sh $PROJECT_ROOT/scripts/github/build-wp-composer

    # - name: ssh-add 2 method
    #   uses: webfactory/ssh-agent@v0.1.1
    #   with:
    #       STAGING_PRIVATE_KEY: ${{ secrets.STAGING_PRIVATE_KEY }}

    # - name: Run WP composer build
    #   run: |
    #     ssh-add -l
    #     echo Add other actions to build,
    #     echo test, and deploy your project.
    #     composer update
    #     ls web -al   
    #     ls web/wp -al

    - name: Run WP Visual regression test
      run: |
        echo Add other actions to build,
        echo test, and deploy your project.
        composer update
        ls web -al   
        ls web/wp -al
        ls -al
        npm -v
        npm install -g backstopjs

